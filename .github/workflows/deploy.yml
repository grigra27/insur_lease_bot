name: Deploy to Timeweb Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  BOT_NAME: "insur_lease_bot"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Lint code
        run: |
          python -m py_compile bot.py
          echo "âœ… Code syntax check passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Timeweb
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USERNAME }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          envs: TELEGRAM_BOT_TOKEN,ADMIN_TELEGRAM_BOT_TOKEN,ADMIN_TELEGRAM_USER_ID,BOT_NAME
          script: |
            # Set environment variables
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export ADMIN_TELEGRAM_BOT_TOKEN="${{ secrets.ADMIN_TELEGRAM_BOT_TOKEN }}"
            export ADMIN_TELEGRAM_USER_ID="${{ secrets.ADMIN_TELEGRAM_USER_ID }}"
            export BOT_NAME="${{ env.BOT_NAME }}"
            
            # Navigate to deployment directory
            cd /opt/insur_lease_bot || {
              echo "Creating project directory..."
              sudo mkdir -p /opt/insur_lease_bot
              sudo chown $USER:$USER /opt/insur_lease_bot
              cd /opt/insur_lease_bot
            }
            
            # Update code from repository
            if [ -d ".git" ]; then
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone ${{ github.server_url }}/${{ github.repository }} .
            fi
            
            # Create .env file from secrets
            cat > .env << EOF
            TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN
            ADMIN_TELEGRAM_BOT_TOKEN=$ADMIN_TELEGRAM_BOT_TOKEN
            ADMIN_TELEGRAM_USER_ID=$ADMIN_TELEGRAM_USER_ID
            EOF
            
            # Create logs directory and log file
            mkdir -p logs
            rm -rf user_queries.log
            touch user_queries.log
            
            # Stop and remove existing containers
            docker compose down || true
            
            # Clean up old images
            docker image prune -f || true
            
            # Start new version
            docker compose up -d --build
            
            # Wait for container to start
            sleep 15
            
            # Check status
            docker compose ps
            docker compose logs --tail=20
