name: Deploy to Timeweb Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: "insur-lease-bot"

jobs:
  test-ssh:
    runs-on: ubuntu-latest
    steps:
      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection..."
          echo "Host: ${{ secrets.TIMEWEB_HOST }}"
          echo "Username: ${{ secrets.TIMEWEB_USERNAME }}"
          
          # Создаем временный SSH ключ
          mkdir -p ~/.ssh
          echo "${{ secrets.TIMEWEB_SSH_KEY }}" > ~/.ssh/temp_key
          chmod 600 ~/.ssh/temp_key
          
          # Проверяем формат ключа
          echo "SSH key format check:"
          head -1 ~/.ssh/temp_key
          tail -1 ~/.ssh/temp_key
          
          # Проверяем длину ключа
          wc -l ~/.ssh/temp_key
          
          # Пробуем подключиться с разными портами
          echo "Trying different SSH ports..."
          ssh -v -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ~/.ssh/temp_key ${{ secrets.TIMEWEB_USERNAME }}@${{ secrets.TIMEWEB_HOST }} "echo 'SSH works on port 22'" 2>&1 || echo "Port 22 failed"
          
          rm ~/.ssh/temp_key

  deploy:
    needs: test-ssh
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Timeweb Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.TIMEWEB_HOST }}
          username: ${{ secrets.TIMEWEB_USERNAME }}
          key: ${{ secrets.TIMEWEB_SSH_KEY }}
          timeout: 10m
          debug: true
          script: |
            set -e
            
            # Переходим в директорию проекта
            cd /home/deploy/insur_lease_bot || {
              echo "Creating project directory..."
              mkdir -p /home/deploy/insur_lease_bot
              cd /home/deploy/insur_lease_bot
            }
            
            # Обновляем код из репозитория
            if [ -d ".git" ]; then
              echo "Updating existing repository..."
              git fetch origin
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone ${{ github.server_url }}/${{ github.repository }} .
            fi
            
            # Создаем .env файл из секретов
            cat > .env << EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            ADMIN_TELEGRAM_BOT_TOKEN=${{ secrets.ADMIN_TELEGRAM_BOT_TOKEN }}
            ADMIN_TELEGRAM_USER_ID=${{ secrets.ADMIN_TELEGRAM_USER_ID }}
            EOF
            
            # Создаем директорию для логов
            mkdir -p logs
            
            # Останавливаем старые контейнеры
            docker compose down || true
            
            # Удаляем старые образы
            docker image prune -f || true
            
            # Запускаем новую версию
            docker compose up -d --build
            
            # Проверяем статус
            sleep 10
            docker compose ps
            docker compose logs --tail=20
